(function(){function a(a,b,c){var d=b&&c||0,e=0;for(b=b||[],a.toLowerCase().replace(/[0-9a-f]{2}/g,function(a){16>e&&(b[d+e++]=m[a])});16>e;)b[d+e++]=0;return b}function b(a,b){var c=b||0,d=l;return d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]}function c(a,c,d){var e=c&&d||0,f=c||[];a=a||{};var g=null!=a.clockseq?a.clockseq:q,h=null!=a.msecs?a.msecs:(new Date).getTime(),i=null!=a.nsecs?a.nsecs:s+1,j=h-r+(i-s)/1e4;if(0>j&&null==a.clockseq&&(g=g+1&16383),(0>j||h>r)&&null==a.nsecs&&(i=0),i>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");r=h,s=i,q=g,h+=122192928e5;var k=(1e4*(268435455&h)+i)%4294967296;f[e++]=k>>>24&255,f[e++]=k>>>16&255,f[e++]=k>>>8&255,f[e++]=255&k;var l=h/4294967296*1e4&268435455;f[e++]=l>>>8&255,f[e++]=255&l,f[e++]=l>>>24&15|16,f[e++]=l>>>16&255,f[e++]=g>>>8|128,f[e++]=255&g;for(var m=a.node||p,n=0;6>n;n++)f[e+n]=m[n];return c?c:b(f)}function d(a,c,d){var f=c&&d||0;"string"==typeof a&&(c="binary"==a?new k(16):null,a=null),a=a||{};var g=a.random||(a.rng||e)();if(g[6]=15&g[6]|64,g[8]=63&g[8]|128,c)for(var h=0;16>h;h++)c[f+h]=g[h];return c||b(g)}var e,f=this;if("function"==typeof f.require)try{var g=f.require("crypto").randomBytes;e=g&&function(){return g(16)}}catch(h){}if(!e&&f.crypto&&crypto.getRandomValues){var i=new Uint8Array(16);e=function(){return crypto.getRandomValues(i),i}}if(!e){var j=new Array(16);e=function(){for(var a,b=0;16>b;b++)0===(3&b)&&(a=4294967296*Math.random()),j[b]=a>>>((3&b)<<3)&255;return j}}for(var k="function"==typeof f.Buffer?f.Buffer:Array,l=[],m={},n=0;256>n;n++)l[n]=(n+256).toString(16).substr(1),m[l[n]]=n;var o=e(),p=[1|o[0],o[1],o[2],o[3],o[4],o[5]],q=16383&(o[6]<<8|o[7]),r=0,s=0,t=d;if(t.v1=c,t.v4=d,t.parse=a,t.unparse=b,t.BufferClass=k,"function"==typeof define&&define.amd)define(function(){return t});else if("undefined"!=typeof module&&module.exports)module.exports=t;else{var u=f.uuid;t.noConflict=function(){return f.uuid=u,t},f.uuid=t}}).call(this),function(a,b){"object"==typeof exports?module.exports=b(require("underscore")):"function"==typeof define&&define.amd?define(["underscore"],b):a.RallyMetrics=b(a._)}(this,function(a){var b=function(b){return{underscore:a}[b]};return(b=function c(a,d,e){function f(h,i){if(!d[h]){if(!a[h]){var j="function"==typeof b&&b;if(!i&&j)return j(h,!0);if(g)return g(h,!0);throw new Error("Cannot find module '"+h+"'")}var k=d[h]={exports:{}};a[h][0].call(k.exports,function(b){var c=a[h][1][b];return f(c?c:b)},k,k.exports,c,a,d,e)}return d[h].exports}for(var g="function"==typeof b&&b,h=0;h<e.length;h++)f(e[h]);return f}({1:[function(a,b){var c=a("underscore"),d=a("./corsBatchSender"),e=window.uuid,f=25,g="__clientMetricsCurrentEventId__",h="__clientMetricsID__",i=function(a){c.extend(this,a),this._pendingEvents=[],this._browserTabId=this._getUniqueId(),this._startingTime=(new Date).getTime(),this._loadedComponents=[],this._errorCount=0,this.errorLimit=this.errorLimit||f,this.handlers=this.handlers||[],this.sender=this.sender||new d({keysToIgnore:["cmp","component"],beaconUrl:a.beaconUrl}),c.isFunction(this.sender.getMaxLength)&&(this.maxErrorLength=Math.floor(.9*this.sender.getMaxLength())),c.isNumber(this.flushInterval)&&(this._flushIntervalId=window.setInterval(c.bind(this.sendAllRemainingEvents,this),this.flushInterval))};i.prototype.destroy=function(){this._flushIntervalId&&window.clearInterval(this._flushIntervalId)},i.prototype.startSession=function(a,b){this._pendingEvents=[],b&&b.sessionStart&&(this._startingTime=b.sessionStart,delete b.sessionStart),this._sessionStartTime=this._getRelativeTime(),this.sendAllRemainingEvents(),this._defaultParams=b,this._errorCount=0,this._loadedComponents=[]},i.prototype.recordAction=function(a){var b=a.component;delete a.component;var d=this._getUniqueId(),e=this._getRelativeTime(a.startTime),f=this._startEvent(c.defaults({eType:"action",cmp:b,cmpH:this._getHierarchyString(b),eDesc:a.description,cmpId:this._getComponentId(b),eId:d,tId:d,status:"Ready",cmpType:this.getComponentType(b),start:e,stop:e},a.miscData));return this._currentTraceId=d,this._finishEvent(f),d},i.prototype.recordError=function(a,b){var d,e;if(c.isObject(a)&&a.errorInfo&&(d=a,a=d.errorInfo,b=d.miscData,e=d.traceId),e=e||this._currentTraceId,e&&this._errorCount<this.errorLimit){++this._errorCount;var f=a||"unknown error";this.maxErrorLength&&(f=f.substring(0,this.maxErrorLength));var g=this._getRelativeTime(),h=this._startEvent(c.defaults({eType:"error",error:f,eId:this._getUniqueId(),tId:e,start:g,stop:g},b));this._finishEvent(h),this.sendAllRemainingEvents()}},i.prototype.recordComponentReady=function(a){if(!c.isUndefined(this._sessionStartTime)){var b=a.traceId||this._currentTraceId,d=a.component,e=this._getHierarchyString(d),f=this._loadedComponents.indexOf(e)>-1;if(!f){this._loadedComponents.push(e);var g=this._startEvent(c.defaults({eType:"load",start:this._sessionStartTime,stop:this._getRelativeTime(a.stopTime),eId:this._getUniqueId(),tId:b,pId:b,cmpType:this.getComponentType(d),cmpH:e,eDesc:"component ready",componentReady:!0},a.miscData));this._finishEvent(g)}}},i.prototype.startSpan=function(a){var b=this,d=a.component,e=a.traceId||this._currentTraceId;if(e){var f=this._getRelativeTime(a.startTime),g=this._getUniqueId(),h=c.defaults({eType:a.type||"load",cmp:d,cmpH:a.hierarchy||this._getHierarchyString(d),eId:g,cmpType:a.name||this.getComponentType(d),tId:e,pId:a.pId||e,start:f},a.miscData);return a.description&&(h.eDesc=a.description),{data:this._startEvent(h),end:function(a){a=a||{},a.stop=b._getRelativeTime(a.stopTime),b._shouldRecordEvent(this.data,a)&&b._finishEvent(this.data,c.extend({status:"Ready"},a))}}}},i.prototype.endSpan=function(){},i.prototype.beginLoad=function(a){var b=a.component,d=a.traceId||this._currentTraceId;if(d&&!b[g+"load"]){var e=this._getRelativeTime(a.startTime),f=this._getUniqueId();b[g+"load"]=f;var h=c.defaults({eType:"load",cmp:b,cmpH:this._getHierarchyString(b),eDesc:a.description,cmpId:this._getComponentId(b),eId:f,cmpType:this.getComponentType(b),tId:d,pId:this._findParentId(b,d),start:e},a.miscData);this._startEvent(h)}},i.prototype.endLoad=function(a){var b=a.component,d=b[g+"load"];if(d){delete b[g+"load"];var e=this._findPendingEvent(d);e&&(a.stop=this._getRelativeTime(a.stopTime),this._shouldRecordEvent(e,a)&&this._finishEvent(e,c.extend({status:"Ready"},a)))}},i.prototype.beginDataRequest=function(a,b,d){var e,f,h;if(1===arguments.length&&(e=arguments[0],a=e.requester,b=e.url,d=e.miscData,f=e.traceId),f=f||this._currentTraceId,a&&f){var i=this._getUniqueId(),j=this._findParentId(a,f),k=this._getUniqueId();a[g+"dataRequest"+k]=i,this._startEvent(c.defaults({eType:"dataRequest",cmp:a,cmpH:this._getHierarchyString(a),url:this._getUrl(b),cmpType:this.getComponentType(a),cmpId:this._getComponentId(a),eId:i,tId:f,pId:j},d)),h={requestId:k,xhrHeaders:{"X-Trace-Id":f,"X-Parent-Id":i}}}return h},i.prototype.endDataRequest=function(a,b,c){var d;if(1===arguments.length&&(d=arguments[0],a=d.requester,b=d.xhr,c=d.requestId),a){var e=a[g+"dataRequest"+c],f=this._findPendingEvent(e);if(!f)return;var h={status:"Ready",stop:this._getRelativeTime()},i=this._getRallyRequestId(b);i&&(h.rallyRequestId=i),this._finishEvent(f,h)}},i.prototype.sendAllRemainingEvents=function(){this.sender.flush()},i.prototype.getComponentType=function(a){return this._getFromHandlers(a.singleton||a,"getComponentType")},i.prototype.getDefaultParams=function(){return this._defaultParams},i.prototype.getSessionStartTime=function(){return this._sessionStartTime},i.prototype._getUniqueId=function(){return e.v4()},i.prototype._getRelativeTime=function(a){return(a||(new Date).getTime())-this._startingTime},i.prototype._finishEvent=function(a,b){var d=c.defaults(b||{},a,this._defaultParams,this._guiTestParams);this._pendingEvents=c.without(this._pendingEvents,a),this.sender.send(d)},i.prototype._startEvent=function(a){if(a.bts=(new Date).getTime(),a.tabId=this._browserTabId,c.isNumber(a.start)||(a.start=this._getRelativeTime()),a.cmp){var b=this._getFromHandlers(a.cmp,"getAppName");b&&(a.appName=b)}return this._pendingEvents.push(a),a},i.prototype._getFromHandlers=function(a,b){var d=null;return c.each(this.handlers,function(c){return d=c[b](a),!d}),d},i.prototype._findParentId=function(a,b){var d=this._getHierarchy(a),e=b;return c.each(d,function(d){var f=c.findLast(this._pendingEvents,function(c){return"dataRequest"!==c.eType&&(c.cmp===d||c.cmp===a)&&c.tId===b});return f?(e=f.eId,!1):void 0},this),e},i.prototype._getComponentId=function(a){return a[h]||(a[h]=this._getUniqueId()),a[h]},i.prototype._getHierarchy=function(a){for(var b=this.getComponentType(a),c=[];b;)c.push(a),a=a.clientMetricsParent||a.ownerCt||a.owner||a.initialConfig&&a.initialConfig.owner,b=a&&this.getComponentType(a);return c},i.prototype._getHierarchyString=function(a){var b=this._getHierarchy(a);return 0===b.length?"none":c.map(b,function(a){return this.getComponentType(a)},this).join(":")},i.prototype._getUrl=function(a){if(!a)return"unknown";var b,c="webservice/",d=a.indexOf(c);if(d>-1){b=a.indexOf("?",d),0>b&&(b=a.length);var e=c.length;return a.substring(d+e,b)}return b=a.indexOf("?"),0>b?a:a.substring(0,b)},i.prototype._getRallyRequestId=function(a){var b="RallyRequestID";if(a){if(c.isString(a))return a;if(c.isObject(a.responseHeaders))return a.responseHeaders.RallyRequestID;if(c.isFunction(a.getResponseHeader))return a.getResponseHeader(b);if(c.isObject(a.getResponseHeader))return a.getResponseHeader[b];if(c.isFunction(a.headers))return a.headers(b)}},i.prototype._findPendingEvent=function(a){return c.find(this._pendingEvents,{eId:a})},i.prototype._shouldRecordEvent=function(a,b){return b.whenLongerThan&&b.stop-a.start<=b.whenLongerThan?(this._pendingEvents=c.without(this._pendingEvents,a),!1):!0},b.exports=i},{"./corsBatchSender":2}],2:[function(a,b){var c=a("underscore"),d=a("./util"),e=25,f=100,g=function(a){c.defaults(this,a,{keysToIgnore:[],minNumberOfEvents:e,maxNumberOfEvents:f,beaconUrl:"https://trust.f4tech.com/beacon/"}),this._eventQueue=[]};g.prototype.send=function(a){this._eventQueue.push(this._cleanEvent(a)),this._sendBatches()},g.prototype.flush=function(){this._sendBatches({flush:!0})},g.prototype.getPendingEvents=function(){return this._eventQueue},g.prototype.getMaxLength=function(){return this.maxLength},g.prototype._sendBatches=function(a){for(var b;b=this._getNextBatch(a);)this._sendBatch(b)},g.prototype._cleanEvent=function(a){return c.omit(a,this.keysToIgnore)},g.prototype._getNextBatch=function(a){var b=c.take(this._eventQueue,this.maxNumberOfEvents);return b.length&&(b.length>=this.minNumberOfEvents||a&&a.flush)?b:void 0},g.prototype._appendIndexToKeys=function(a,b){return c.transform(a,function(a,c,d){a[d+"."+b]=c})},g.prototype._sendBatch=function(a){this._disabled||this._makePOST(a),this._eventQueue=c.difference(this._eventQueue,a)},g.prototype._getUrl=function(){return this.beaconUrl},g.prototype._disableClientMetrics=function(){this._disabled=!0},g.prototype._allValuesAsStrings=function(a){return c.forIn(a,function(a,b,d){c.isString(a)||(d[b]=""+a)})},g.prototype._makePOST=function(a){var b=c.reduce(a,function(a,b,d){return b=this._allValuesAsStrings(b),c.extend(a,this._appendIndexToKeys(b,d))},{},this);try{var e=d.createCorsXhr("POST",this.beaconUrl);e?(e.onerror=c.bind(this._disableClientMetrics,this),setTimeout(function(){e.send(JSON.stringify(b))},0)):this._disableClientMetrics()}catch(f){this._disableClientMetrics()}},b.exports=g},{"./util":5}],sOmqIC:[function(a,b){b.exports={Aggregator:a("./aggregator"),CorsBatchSender:a("./corsBatchSender"),Util:a("./util"),WindowErrorListener:a("./windowErrorListener")}},{"./aggregator":1,"./corsBatchSender":2,"./util":5,"./windowErrorListener":6}],RallyMetrics:[function(a,b){b.exports=a("sOmqIC")},{}],5:[function(a,b){!function(){var c=a("underscore"),d={addEventHandler:function(a,b,c,d){a.addEventListener?a.addEventListener(b,c,d):a.attachEvent&&a.attachEvent("on"+b,c)},removeEventHandler:function(a,b,c){a.removeEventListener?a.removeEventListener(b,c):a.detachEvent&&a.detachEvent("on"+b,c)},removeFromDom:function(a){c.isFunction(a.remove)?a.remove():a.parentNode&&a.parentNode.removeChild(a)},createCorsXhr:function(a,b){var c=new XMLHttpRequest;return"withCredentials"in c?(c.open(a,b,!0),c.setRequestHeader("Content-type","application/json; charset=utf-8")):"undefined"!=typeof XDomainRequest?(c=new XDomainRequest,c.onload=function(){},c.onprogress=function(){},c.ontimeout=function(){},c.open(a,b)):c=null,c}};b.exports=d}()},{}],6:[function(a,b){!function(){var c=a("underscore"),d=a("./util"),e=!0,f=c.template("<%= message %>, <%= filename %>:<%= lineNumber %>"),g=c.template("onerror::<%= message %>, <%= filename %>:<%= lineNumber %>"),h=function(a,b,f){var g=c.isBoolean(b)?b:e;this.aggregator=a,this._stackLimit=null,f&&f.stackLimit&&(this._stackLimit=parseInt(f.stackLimit,10)),g?(this._originalWindowOnError=window.onerror,window.onerror=c.bind(this._windowOnError,this)):d.addEventHandler(window,"error",c.bind(this._onUnhandledError,this),!1)};c.extend(h.prototype,{_windowOnError:function(a,b,d,e,g){c.isFunction(this._originalWindowOnError)&&this._originalWindowOnError.call(window,a,b,d);var h=f({message:a||"unknown message",filename:b||"??",lineNumber:c.isNumber(d)?d:"??"}),i={};e&&(i.columnNumber=e),g&&g.stack&&(i.stack=g.stack,this._stackLimit&&(i.stack=c.take(i.stack.split("\n"),this._stackLimit).join("\n"))),this.aggregator.recordError(h,i)},_onUnhandledError:function(a){var b;b=a.browserEvent?g({message:a.browserEvent.message||"unknown message",filename:a.browserEvent.filename||"??",lineNumber:a.browserEvent.lineno||"??"}):"onerror::"+(a.message||"unknown error"),this.aggregator.recordError(b)}}),b.exports=h}()},{"./util":5}]},{},["sOmqIC"]))("RallyMetrics")});